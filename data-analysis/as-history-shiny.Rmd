---
title: "Untitled"
author: "Darius Sas"
date: "February 26, 2019"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
library(ggplot2)
library(gridExtra)
library(ggpubr)
library(ggrepel)
knitr::opts_chunk$set(echo = TRUE)
source("as-history-all/signal-analysis.R")
source("as-history-all/correlation-analysis.R")

options(shiny.maxRequestSize = 60*1024^2)
```
# Research question 1
## Smell characteristic trend analysis
Select an input file and click the "Upload" button. Next, after selecting the characteristic which signal to analyse, click "Compute" and wait for the computation to complete and the plots to appear.
```{r fileinput, echo=FALSE}
inputPanel(
         fileInput("dataset", "Choose a file", accept = c("text/csv","text/comma-separated-values,text/plain",".csv")),
         actionButton("calculate", "Upload"),
         uiOutput("characteristicSelector")
)
data <- eventReactive(input$calculate, {read.csv(input$dataset$datapath)})
characteristic <- eventReactive(input$compute, {input$characteristic})
data.sig <- reactive({
    df <- data()
    char <- characteristic()
    signalType <- classifiableSignals[classifiableSignals$signal == char, "type"]
    if (signalType != "generic") {
      df <- df[df$smellType == as.character(signalType), ]  
    }

   return(classifySignal(df, char))
})
```
The analysed signal is shown below as a matrix of pie plots. Each row is a different project,  whereas columns are the different smell types.
The first row shows the data grouped for all projects.
```{r signalAnalysis, echo=FALSE}
renderUI({
    df <- data()
    inputPanel(
      selectInput("characteristic", "Select a signal to classify", signalNames, selected = "size"),
      actionButton("compute", "Compute"))
})
renderPlot({
    df.sig <- data.sig()
    print("Initiated signal analysis")
    palette = "Dark2"
    
    df.sig <- df.sig %>% group_by(classification) %>% add_tally()
    p <- ggplot(df.sig, aes(x="", group=classification, fill=classification)) + 
      geom_bar(stat="count", position=position_fill(vjust =1)) + coord_polar("y") +
      scale_fill_brewer(palette=palette) +
      theme(plot.title = element_text(size=9),
            axis.text = element_blank(),
            axis.ticks = element_blank(),
            legend.position = "top") + 
      labs(x="Projects", y="Smell types") 
   
    singleProjectsPlot <- p + facet_grid(vars(project), vars(smellType))
    allProjectsPlot <- p + facet_grid(cols = vars(smellType))

    print("Signal analysis completed")
    grid.arrange(allProjectsPlot, singleProjectsPlot)
},width = 900, height = 2000, res = 100)

```

The plot below, instead, shows us the correlation between the classifications of the selected signal and the age of that smell.
For each test performed, p-values are shown only if less than ```0.05```.
```{r iccor, echo=FALSE}

renderPlot({
    df.sig <- data.sig()
    
    df.icc <- data.frame()
    for (smellType in unique(df.sig$smellType)) {
      df.smell <- df.sig[df.sig$smellType == smellType,]
      icc <- computeCorrelMatrix(df.smell)
      icc$smellType <- smellType
      df.icc <- rbind(df.icc, icc)
    }
    ggplot(df.icc, aes(type, ICC), group=smellType, color=smellType, fill=smellType) + 
      geom_point(aes(size = p, color=smellType, fill=smellType), alpha=0.9) +
      geom_label_repel(aes(label = ifelse(p<=0.05, as.character(round(p, digits = 3)), "")),
                       box.padding   = 0.35, 
                       point.padding = 0.5,
                       segment.color = 'grey50') +
      labs(title = paste("ICC correlation analysis of", input$characteristic, "with signal classification"), y = "Correlation test", "Correlation factor") +
      theme_classic()
  })

```

## Smell-generic characteristics correlation
The correlation between the smell-generic characteristics is depicted below
```{r charcorr, echo=FALSE}
renderPlot({
  df <- data()
  df.corr <- computeCharacteristicCorrelation(df, c("generic"))
  df.corr$var <- paste(df.corr$var1, df.corr$var2)
  df.corr.validity <- df.corr %>% mutate(isValid = p.value >= 0.05) %>% group_by(isValid) %>% tally()
  ggplot(df.corr.validity, aes(isValid, n)) + geom_bar(aes(color = isValid, fill=isValid), stat = "identity")
  df.corr <- df.corr %>% filter(p.value <= 0.05)
  ggplot(df.corr, aes(project, estimate, group = var)) + geom_point(aes(size = age, fill=smellType, color=smellType)) + facet_wrap(~var)
})
```




